---
-
  name: "Creating installation directories for domino-rest-api"
  file:
    path: "{{ item }}"
    state: directory
  with_items:
    - "{{ installer_dir }}/domino-rest-api/archives"

- 
  name: "Checking if domino-rest-api {{ domino_rest_api_version }} installer is at {{ installer_dir }}/domino-rest-api/archives/{{ domino_rest_api_archive }}"
  register: domino_server_installer_check
  stat:
    path: "{{ installer_dir }}/domino-rest-api/archives/{{ domino_rest_api_archive }}"
    get_md5: no

- 
  name: "Checking if domino-rest-api {{ domino_rest_api_version }} is installed"
  register: domino_rest_api_installed_check
  stat:
    path: "{{ completed_dir }}/domino_rest_api_install"
    get_md5: no

#- 
#  name: "Downloading domino-rest-api {{ domino_rest_api_version }} from {{ domino_installer_base_url }}"
#  register: domino-rest-apiresult
#  until: "domino-rest-apiresult is not failed"
#  retries: 3
#  get_url:
#    url: "{{ domino_installer_base_url }}/domino-rest-api/{{ domino_rest_api_archive }}"
#    dest: "{{ installer_dir }}/domino-rest-api/archives/{{ domino_rest_api_archive }}"
#    username: "{{ domino_installer_url_user }}"
#    password: "{{ secrets.domino_installer_url_pass }}"
#  when: domino_server_installer_check.stat.exists == false and domino_rest_api_installed_check.stat.exists == false

-
  name: "Extracting domino-rest-api {{ domino_rest_api_version }} from {{ domino_rest_api_archive }}"
  when:  domino_rest_api_installed_check.stat.exists == false
  unarchive:
    mode: "a+x"
    owner: "{{ domino_user }}"
    group: "{{ domino_group }}"
    src: "{{ installer_dir }}/domino-rest-api/archives/{{ domino_rest_api_archive }}"
    dest: "{{ installer_dir }}/domino-rest-api"
    creates: "{{ installer_dir }}/domino-rest-api/restapiInstall.jar"
    remote_src: true

- 
  name: "Stopping Domino for domino-rest-api Installation"
  when: domino_rest_api_installed_check.stat.exists == false
  become: true
  service:
    name: domino
    state: stopped
    enabled: yes

-
  name: "Installing Domino Rest API"
  shell: "{{ item }}"
  become: true
  become_user: "{{ service_user }}"
  args:
    chdir: "{{ installer_dir }}/domino-rest-api"
    executable: /bin/bash
  when: domino_rest_api_installed_check.stat.exists == false
  with_items:
    - "sudo java -jar restapiInstall.jar -d={{ domino_home_dir }} -i={{ domino_home_dir }}/notes.ini -r=/opt/hcl/restapi -p={{ domino_install_dir }} -a"

-
  name: "Marking Domino Rest API as installed"
  when: domino_rest_api_installed_check.stat.exists == false
  file:
    path: "{{ item }}"
    state: touch
  with_items:
    - "{{ completed_dir }}/domino_rest_api_install"

- 
  name: "Starting Domino"
  when: domino_rest_api_installed_check.stat.exists == false
  become: true
  service:
    name: domino
    state: started
    enabled: yes
