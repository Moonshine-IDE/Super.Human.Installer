---
- 
  name: "Installing MariaDB"
  apt: 
    name: 
      - mariadb-server

- 
  name: "Starting MariaDB"
  systemd: 
    name: mariadb
    state: started

- 
  name: "Sets the {{ mariadb_admin_user }} password"
  become: true
  ignore_errors: true
  mysql_user: 
    user: "{{ mariadb_admin_user }}"
    password: "{{ mariadb_admin_pass }}"
    host: localhost

- 
  name: "Securing MariaDB"
  become: true   
  expect:
    command: mysql_secure_installation
    responses:
      'Enter current password for root \(enter for none\): ': ''
      'Switch to unix_socket authentication \[Y\/n\] ': 'n'
      'Change the root password\? \[Y\/n\] ': 'y'
      'New password:': "{{ mariadb_admin_pass }}"
      'Re-enter new password:': "{{ mariadb_admin_pass }}"
      'Remove anonymous users\? \[Y\/n\]': 'y'
      'Disallow root login remotely\? \[Y\/n\]': 'n'
      'Remove test database and access to it\? \[Y\/n\]': 'y'
      'Reload privilege tables now\? \[Y\/n\]': 'y'

- 
  name: "configurating MariaDB to bind to all ports"
  lineinfile:
    path: "{{ item.dir }}"
    regexp: "^bind-address"
    create: true
    line: "bind-address  = 0.0.0.0"
  with_items:
    - { dir: "/etc/mysql/mariadb.conf.d/50-server.cnf" }

- 
  name: "Restarting MariaDB"
  systemd: 
    name: mariadb
    state: restarted