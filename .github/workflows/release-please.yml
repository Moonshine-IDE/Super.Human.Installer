name: Release Please

on:
  push:
    branches:
      - master

permissions:
  contents: write
  pull-requests: write
  issues: write
  actions: write
  pages: write
  id-token: write

jobs:
  release-please:
    name: Release Please
    runs-on: [self-hosted, linux]
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
      major: ${{ steps.release.outputs.major }}
      minor: ${{ steps.release.outputs.minor }}
      patch: ${{ steps.release.outputs.patch }}
      is_patch: ${{ steps.check.outputs.is_patch }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0
      - uses: googleapis/release-please-action@v4
        id: release
      - id: check
        if: ${{ steps.release.outputs.release_created }}
        run: |
          PREV=$(git tag --sort=-version:refname | grep -E '^v[0-9]+\.[0-9]+\.[0-9]+$' | head -n 2 | tail -n 1 | sed 's/v//')
          if [[ "$PREV" =~ ^([0-9]+)\.([0-9]+)\. ]] && [ "${BASH_REMATCH[1]}" = "${{ steps.release.outputs.major }}" ] && [ "${BASH_REMATCH[2]}" = "${{ steps.release.outputs.minor }}" ]; then
            echo "is_patch=true" >> $GITHUB_OUTPUT
          else
            echo "is_patch=false" >> $GITHUB_OUTPUT
          fi

  build-linux:
    name: Build Linux
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    uses: Moonshine-IDE/Super.Human.Installer/.github/workflows/sub-build-linux.yml@master
    secrets: inherit
    with:
      env: ${{ needs.release-please.outputs.is_patch == 'true' && 'Development' || 'Production' }}
      version: ${{ needs.release-please.outputs.major }}.${{ needs.release-please.outputs.minor }}.${{ needs.release-please.outputs.patch }}

  build-macos:
    name: Build macOS
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    uses: Moonshine-IDE/Super.Human.Installer/.github/workflows/sub-build-macos.yml@master
    secrets: inherit
    with:
      env: ${{ needs.release-please.outputs.is_patch == 'true' && 'Development' || 'Production' }}
      version: ${{ needs.release-please.outputs.major }}.${{ needs.release-please.outputs.minor }}.${{ needs.release-please.outputs.patch }}

  build-windows:
    name: Build Windows
    needs: release-please
    if: ${{ needs.release-please.outputs.release_created }}
    uses: Moonshine-IDE/Super.Human.Installer/.github/workflows/sub-build-windows.yml@master
    secrets: inherit
    with:
      env: ${{ needs.release-please.outputs.is_patch == 'true' && 'Development' || 'Production' }}
      version: ${{ needs.release-please.outputs.major }}.${{ needs.release-please.outputs.minor }}.${{ needs.release-please.outputs.patch }}

  release:
    name: Upload Release Assets
    needs: [release-please, build-linux, build-macos, build-windows]
    runs-on: [self-hosted, linux]
    steps:
      - uses: actions/checkout@v6

      - uses: actions/download-artifact@v6
        with:
          name: SuperHumanInstaller-linux-installer

      - uses: actions/download-artifact@v6
        with:
          name: SuperHumanInstaller-windows-installer

      - uses: actions/download-artifact@v6
        with:
          name: SuperHumanInstaller-Choco

      - uses: actions/download-artifact@v6
        with:
          name: SuperHumanInstaller-macos-installer

      - uses: josStorer/get-current-time@v2.1.1
        id: current-time

      - uses: devops-actions/json-to-file@v1.0.3
        with:
          json: |
            {
              "workflow": "production",
              "version": "${{ needs.release-please.outputs.major }}.${{ needs.release-please.outputs.minor }}.${{ needs.release-please.outputs.patch }}",
              "branch": "${{ github.ref_name }}",
              "commit_sha": "${{ github.sha }}",
              "build_date": "${{ steps.current-time.outputs.readableTime }}"
            }
          filename: buildinfo.json

      - uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ needs.release-please.outputs.tag_name }}
          files: |
            SuperHumanInstaller-x86_64.AppImage
            SuperHumanInstaller-Setup.pkg
            SuperHumanInstaller-Setup.exe
            SuperHumanInstaller-Choco.nupkg
            buildinfo.json
          fail_on_unmatched_files: true

  documentation:
    name: Deploy Documentation
    needs: [release-please, release]
    if: ${{ needs.release-please.outputs.is_patch == 'false' }}
    permissions:
      contents: read
      pages: write
      id-token: write
    uses: Moonshine-IDE/Super.Human.Installer/.github/workflows/update-documentation.yml@master
    with:
      tag_name: ${{ needs.release-please.outputs.tag_name }}
